# åŒ»é™¢é‡‡é›†ä¼˜åŒ–å®æ–½è®¡åˆ’ (Rev 5.0 - Final)

ç»å…¨é¢ä»£ç å®¡æŸ¥ï¼Œç¡®è®¤æœ¬è®¡åˆ’è¦†ç›–æ‰€æœ‰æ ¸å¿ƒéœ€æ±‚ä¸æ½œåœ¨ä¾èµ–ã€‚

## ğŸ“… é˜¶æ®µä¸€ï¼šç¯å¢ƒé…ç½®ä¸å·¥ç¨‹åŒ– (Configuration)

- **`.env.example`**ï¼š
  - å®šä¹‰ `STORAGE_BACKEND` (mysql/elasticsearch)ã€‚
  - å®šä¹‰ DB/ES è¿æ¥å‚æ•°ã€‚
- **é…ç½®åŠ è½½**ï¼š
  - ä¿®æ”¹ `settings.py`ï¼Œä½¿ç”¨ `python-dotenv` åŠ è½½ç¯å¢ƒå˜é‡ã€‚

## ğŸ“… é˜¶æ®µäºŒï¼šå­˜å‚¨å±‚æŠ½è±¡ä¸å®ç° (Storage Layer)

- **æ¥å£å®šä¹‰ (`hybrid_crawler/storage/base.py`)**ï¼š
  - `check_existence(ids: List[str]) -> Set[str]`
  - `save_batch(items: List[Item]) -> int`
- **MySQL å®ç° (`hybrid_crawler/storage/mysql.py`)**ï¼š
  - ç»§æ‰¿åŸºç±»ï¼Œè¿ç§»å¹¶ä¼˜åŒ– SQLAlchemy é€»è¾‘ (Insert-Only)ã€‚
- **Elasticsearch å®ç° (`hybrid_crawler/storage/elasticsearch.py`)**ï¼š
  - ä½¿ç”¨ `elasticsearch` å®¢æˆ·ç«¯ï¼Œå®ç° `mget` æŸ¥é‡ä¸ `bulk` å†™å…¥ã€‚
- **Pipeline æ”¹é€ **ï¼š
  - `UniversalBatchWritePipeline` é€šè¿‡å·¥å‚æ¨¡å¼åŠ è½½ Storage å®ä¾‹ã€‚

## ğŸ“… é˜¶æ®µä¸‰ï¼šä¸šåŠ¡æŒ‡çº¹ä¸ Item é‡æ„ (Core Logic)

- **Item Mixin (`hybrid_crawler/items/mixins.py`)**ï¼š
  - åˆ›å»º `BizFingerprintMixin`ï¼Œæä¾› `generate_biz_id` æ–¹æ³•ã€‚
  - é€»è¾‘ï¼š`MD5(Join(Strip(HospitalName, ProductName, ...)))`ã€‚
- **åº”ç”¨**ï¼š
  - å°† Mixin åº”ç”¨äºæ‰€æœ‰ç›®æ ‡çœä»½ (Liaoning, Tianjin, Guangdong, etc.) çš„ Item ç±»ã€‚

## ğŸ“… é˜¶æ®µå››ï¼šå¤šçœä»½è¡¥é‡‡å®¡è®¡ä¸æµ‹è¯• (Recrawl Audit)

### 1. å®¡è®¡èŒƒå›´ (7 çœä»½)
- **ç›®æ ‡**ï¼šä¿®å¤ç¡¬ç¼–ç è·¯å¾„ã€Token/åŠ å¯†é€»è¾‘ã€ç¿»é¡µæ­»å¾ªç¯ã€‚
- **åå•**ï¼šLiaoning, Tianjin, Guangdong, Hebei, Hainan, Fujian, Ningxiaã€‚

### 2. è¡¥é‡‡æµ‹è¯•æœºåˆ¶ (Recrawl Testing)
- **è¶…æ—¶æ§åˆ¶**ï¼š
  - åˆ©ç”¨ `RecrawlManager` ç°æœ‰çš„ `stop_check` å‚æ•°ã€‚
  - åœ¨è°ƒç”¨æ—¶ä¼ å…¥åŸºäº `time.time()` çš„æ£€æŸ¥å‡½æ•°ï¼Œè¶…è¿‡ 2 åˆ†é’Ÿè¿”å› Trueã€‚
- **å¼ºåˆ¶éªŒè¯ (Force Check)**ï¼š
  - åœ¨æµ‹è¯•è„šæœ¬ä¸­å®ç°ã€‚å½“ `find_missing` è¿”å›ç©ºæ—¶ï¼Œéšæœºé€‰å–æ•°æ®åº“ä¸­ 5-10 æ¡è®°å½•ï¼ŒéªŒè¯å…¶æ˜¯å¦çœŸå®å­˜åœ¨ã€‚

### 3. æ„å»ºæµ‹è¯•å¥—ä»¶ (`scripts/debug_recrawl_job.py`)
- **åŠŸèƒ½**ï¼š
  - **è¾“å…¥**ï¼š`spider_name`
  - **æµç¨‹**ï¼š
    1. `Mock Missing`: å†…å­˜æ¨¡æ‹Ÿç¼ºå¤±ã€‚
    2. `Run Recrawl`: å¸¦ `stop_check` (2min) è¿è¡Œã€‚
    3. `Verify`: æ£€æŸ¥å†™å…¥æ—¥å¿— + å¼ºåˆ¶æŸ¥åº“éªŒè¯ã€‚
    4. `Report`: è¾“å‡ºè€—æ—¶ã€è¡¥é‡‡æ•°é‡ã€éªŒè¯ç»“æœã€‚

## ğŸš€ æ‰§è¡Œè·¯å¾„
1.  **Infra**: å»ºç«‹ `.env` ä¸ Storage æŠ½è±¡ã€‚
2.  **Core**: å®Œæˆ Item æŒ‡çº¹ä¸ Pipeline æ”¹é€ ã€‚
3.  **Test**: ç¼–å†™ `debug_recrawl_job.py` æµ‹è¯•è„šæœ¬ã€‚
4.  **Audit**: ä¾æ¬¡å¯¹ 7 ä¸ªçœä»½è¿›è¡Œä»£ç å®¡è®¡ä¸è¿è¡Œæµ‹è¯•ã€‚
